<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>포인트 충전</title>
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script>
        var IMP = window.IMP; 
        IMP.init("imp72705242");

        function chargePoints() {
            const userId = document.getElementById("userId").value; // 사용자 ID
            const amount = document.getElementById("amount").value; // 충전 금액

            if (!amount || amount <= 0) {
                alert("충전 금액을 올바르게 입력하세요.");
                return;
            }

            IMP.request_pay({
                pg: "kakaopay.TC0ONETIME",
                pay_method: "card",
                merchant_uid: "merchant_" + new Date().getTime(),
                name: "포인트 충전",
                amount: amount,
            }, function (rsp) {
                if (rsp.success) {
                    console.log("결제 성공:", rsp); // 디버깅용
                    fetch('/points/charge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            impUid: rsp.imp_uid,
                            amount: rsp.paid_amount,
                            email: userId // 서버에 사용자 이메일 전달
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("서버 응답:", data); // 디버깅용
                        if (data.status === "success") {
                            alert("포인트 충전 성공! 현재 포인트: " + data.points);
                        } else {
                            alert("포인트 충전 실패: " + data.message);
                        }
                    })
                    .catch(error => console.error("요청 실패:", error));
                } else {
                    alert("결제 실패: " + rsp.error_msg);
                }
            });
        }

    </script>
</head>
<body>
    <h1>포인트 충전</h1>
    <input type="hidden" id="userId" th:value="${userId}">

    
    
    <label for="amount">충전 금액:</label>
    <input type="number" id="amount" name="amount" required>
    <br>
    <button type="button" onclick="chargePoints()">충전하기</button>
    <br>
    <a th:href="@{/dashboard}">대시보드로 돌아가기</a>
</body>
</html>
